---
- name: "Destroy and Undefine {{ vms_to_remove }}" 
  block:
    - name: Destroy VM
      community.libvirt.virt:
        name: "{{ item }}"
        state: destroyed
    - name: Undefine VM # The 'loop' default will prevent action when none is needed. # noqa no-changed-when
      shell:
        cmd: "virsh undefine --remove-all-storage --nvram {{ item }}" # community.libvirt.virt undefine doesn't have the ability to specify --nvram
    
